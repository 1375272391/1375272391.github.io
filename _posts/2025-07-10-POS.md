---
layout: post
title:  "PixelOS 15 编译"
author: XM137
date:   2025-07-10 16:29:00 +0800
categories: Android
tags: [Android, PixelOS, LineageOS]
---

也是重拾老本行了

代码在有代理下拉取

本文不是编译教程，不会介绍工具链下载，代码下载

如有疑问，自行查阅官方文档


为什么是`PixelOS`，因为它带GMS，
官方给了一份参考，它是A13时期的，官方只说过时，没说什么时候继续完善
https://blog.pixelos.net/docs/JoinTheTeam/BuildingPixelOS


https://github.com/PixelOS-AOSP/manifest

接下来是项目仓库，其中的`README`文档会告知如何下载，在此不再赘述

即使在有代理的情况下也不能保证连接质量

所以使用国内镜像源进行加速下载

以下链接会告知如何配置

此处使用清华大学提供的镜像服务

https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/
https://mirrors.tuna.tsinghua.edu.cn/help/lineageOS/

首先编译`Android`,`AOSP`代码必不可少，不然......
说是`PixelOS`,其中也引用了`LineageOS`的仓库，所以也为`LineageOS`仓库配置镜像


在初始化仓库完毕以后

做如下修改，配置镜像

需要在`.repo/manifests`目录下作修改

```git
diff --git a/default.xml b/default.xml
index 4760ecc..d2e1140 100644
--- a/default.xml
+++ b/default.xml
@@ -2,7 +2,7 @@
 <manifest>
 
   <remote  name="aosp"
-           fetch="https://android.googlesource.com"
+           fetch="https://mirrors.tuna.tsinghua.edu.cn/git/AOSP"
            review="https://android-review.googlesource.com/" />
   <default revision="refs/tags/android-15.0.0_r32"
            remote="aosp"
```

```git
diff --git a/snippets/lineage.xml b/snippets/lineage.xml
index 580c306..2a5d569 100644
--- a/snippets/lineage.xml
+++ b/snippets/lineage.xml
@@ -2,7 +2,7 @@
 <manifest>
 
   <remote  name="LineageOS"
-           fetch="https://github.com/"
+           fetch="https://mirrors.tuna.tsinghua.edu.cn/git/lineageOS/"
            review="https://review.lineageos.org/"
            revision="refs/heads/lineage-22.2" />
 
```

解决同步时找不到A15的gms分支
```git
diff --git a/snippets/custom.xml b/snippets/custom.xml
index e568003..04d171d 100644
--- a/snippets/custom.xml
+++ b/snippets/custom.xml
@@ -40,7 +40,7 @@
   <project path="packages/apps/Updater" name="packages_apps_Updater" remote="PixelOS" />
   <project path="vendor/aosp" name="vendor_aosp" remote="PixelOS" />
   <project path="vendor/custom-preference" name="vendor_custom-preference" remote="PixelOS" />
-  <project path="vendor/gms" name="vendor_gms" clone-depth="1" remote="PixelOS-Gitlab" />
+  <project path="vendor/gms" name="vendor_gms-15" clone-depth="1" remote="PixelOS-Gitlab" />
   <project path="vendor/google/overlays/ThemeIcons" name="vendor_google_overlays_ThemeIcons" remote="PixelOS" />
 
 </manifest>
 ```


修改完成以后同步代码

记录一下遇到的问题

就是其中因为代理问题造成的克隆中断，导致最后的检出环节出现问题
![](/assets/Daily-image/20250710/2025-07-10%2017-25-16.webp)
在.repo目录下，需要关注 project-objects、 projects两个文件夹
这两个目录与同步代码有关，两者目录结构不完全一致，
在.repo的上级目录，也就是代码同步的目录，也是需要操作的部分


例如
![](/assets/Daily-image/20250710/checkout.webp)
先根据报错找到出错的仓库

其中有提示，使用-j1 --fail-fast 可以在第一次错误时退出

检出时出现的问题，所以我们直接检出，组合命令，
```bash
repo sync -l -j1 --fail-fast
```
就可以定位第一个出现问题的仓库

笔者定位的还是这个仓库，所以不上其他图了

`platform/prebuilts/rust`

![](/assets/Daily-image/20250710/2025-07-10%2017-40-58.webp)
在.repo/project-objects 顺藤摸瓜找到rust

按下`del`给它删了

![](/assets/Daily-image/20250710/2025-07-10%2017-43-11.webp)
.repo/projects目录下并没有platform目录，但是有prebuilts目录
其中找到了`rust.git`

二者对应关系可参考`.repo/manifest/default.xml`
你会找到答案的

最后回到非.repo目录
在其中的prebuilts目录下有rust文件夹

找到这三个文件夹，给它删除

再次观察`.repo/manifest/default.xml`
发现了吧

之后，只同步这个仓库
```bash
repo sync -n platform/prebuilts/rust
```
在同步完成以后，
```bash
repo sync -l -j1 --fail-fast
```
再次检出

很遗憾还是它

在源码同步目录，非`.repo`目录，也就是上文最后一个提到的文件夹删除

再次重新检出
顺利完成

最后再`repo sync`一次，若不再报错，即同步完成

下面根据特定设备，下载所需文件进行编译

根据官方文档的意思，被官方支持的设备应该可以直接`lunch`后直接下载所需文件


但是笔者的设备不在该项目官方支持列表中，但`xiaomi mix2s` 有 `LineageOS` 官方维护，所以使用`LineageOS`提供的设备树文件进行编译
在此感谢`mix2s` `LineageOS` 官方维护者所做的工作

由于`PixelOS`与`LineageOS`的目录结构存在差异，所以对其中的路径做出一些必要修改

`xiaomi mix2s` 代号 `polaris`
我们可以根据设备代号查找设备树文件

例如查找到的仓库

https://github.com/LineageOS/android_device_xiaomi_polaris/

然后根据
`lineage.dependencies`

```dependencies
[
  {
    "repository": "android_device_xiaomi_sdm845-common",
    "target_path": "device/xiaomi/sdm845-common"
  }
]
```

查找其他相关仓库，一并下载下来

我们组合命令
```
git clone https://github.com/LineageOS/android_device_xiaomi_sdm845-common -b lineage-22.2 device/xiaomi/sdm845-common --depth=1
```
`LineageOS 22.2` 与 `PixelOS 15` 在AOSP部分，二者都是 `android-15.0.0_r32` 所以采用`lineage-22.2`分支

然后再次查看`android_device_xiaomi_sdm845-common`仓库中的`dependencies`文件，继续下载其他所需文件

最后一个
```
git clone https://github.com/PixelOS-AOSP/hardware_xiaomi -b fifteen hardware/xiaomi --depth=1
```
采用PixelOS的仓库，因为它提供了，所以用它的

最后的`--depth=1`意思是拉取最新的一次提交，历史提交不必拉取，除非你需要




```git
diff --git a/AndroidProducts.mk b/AndroidProducts.mk
index 5bafed4..e77ff93 100644
--- a/AndroidProducts.mk
+++ b/AndroidProducts.mk
@@ -14,4 +14,4 @@
 # limitations under the License.
 
 PRODUCT_MAKEFILES := \
-    $(LOCAL_DIR)/lineage_polaris.mk
+    $(LOCAL_DIR)/aosp_polaris.mk
diff --git a/lineage_polaris.mk b/aosp_polaris.mk
similarity index 90%
rename from lineage_polaris.mk
rename to aosp_polaris.mk
index 4c7cebc..86d3ce3 100644
--- a/lineage_polaris.mk
+++ b/aosp_polaris.mk
@@ -7,7 +7,7 @@
 $(call inherit-product, device/xiaomi/polaris/device.mk)
 
 # Inherit some common Lineage stuff.
-$(call inherit-product, vendor/lineage/config/common_full_phone.mk)
+$(call inherit-product, vendor/aosp/config/common_full_phone.mk)
 
 # Device identifier. This must come after all inclusions.
 PRODUCT_NAME := lineage_polaris

```

```git
diff --git a/BoardConfigCommon.mk b/BoardConfigCommon.mk
index 29e0b3a..791bcb2 100644
--- a/BoardConfigCommon.mk
+++ b/BoardConfigCommon.mk
@@ -55,7 +55,7 @@ DEVICE_FRAMEWORK_COMPATIBILITY_MATRIX_FILE := \
     hardware/qcom-caf/common/vendor_framework_compatibility_matrix.xml \
     hardware/qcom-caf/common/vendor_framework_compatibility_matrix_legacy.xml \
     hardware/xiaomi/vintf/xiaomi_framework_compatibility_matrix.xml \
-    vendor/lineage/config/device_framework_matrix.xml
+    vendor/aosp/config/device_framework_matrix.xml
 DEVICE_MANIFEST_FILE := $(COMMON_PATH)/manifest.xml
 DEVICE_MATRIX_FILE := hardware/qcom-caf/common/compatibility_matrix.xml
 
@@ -92,7 +92,7 @@ BOARD_SUPER_PARTITION_GROUPS := qti_dynamic_partitions
 BOARD_QTI_DYNAMIC_PARTITIONS_PARTITION_LIST := odm product system system_ext vendor
 BOARD_QTI_DYNAMIC_PARTITIONS_SIZE := 5163188224 # (BOARD_SUPER_PARTITION_SIZE - 4194304) 4MiB overhead
 
-include vendor/lineage/config/BoardConfigReservedSize.mk
+include vendor/aosp/config/BoardConfigReservedSize.mk
 
 TARGET_USERIMAGES_USE_EXT4 := true
 TARGET_USERIMAGES_USE_F2FS := true
```



在设备目录下，执行extract-files.py 提取所需blob文件，如何提取，LineageOS wiki中有答案，请自行查阅

在完成设备树修改与提取设备blob文件后

在代码目录
```
. build/envsetup.sh
lunch aosp_polaris-bp1a-userdebug
mka bacon
```
如对命令有疑问，请自行查阅官方仓库文档

开始编译，起飞
![](/assets/Daily-image/20250710/make1.webp)

历经两个半小时，编译完成
![](/assets/Daily-image/20250710/make2.webp)

刷入
![](/assets/Daily-image/20250710/sideload.webp)

![](/assets/Daily-image/20250710/POS15.webp)

最后，
![](/assets/Daily-image/20250710/image1.webp)
记得第一次适配时，查日志发现名字也被编译进去得那种喜悦